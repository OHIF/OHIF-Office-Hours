# OHIF Office Hours Notes 2025-10-14

## Q & A

attendees: 9


### One-line summaries

- üñºÔ∏è Issue with mammography images not rendering correctly traced to buggy Sigmoid LUT implementation in Cornerstone3D; temporary fix is to fall back to linear transfer function.  
- ‚è±Ô∏è No ETA for permanent fix yet; workaround is to revert Sigmoid handling to linear until bug in Cornerstone3D is resolved.


--- 

üñºÔ∏è **Continuing this issue  
There seems to be a problem on some mammography images, not being able to properly render. The same files render fine in other viewers.  
When these images load, this warning appears, and adjusting the window level completely breaks the render, assigning an extremely large value. We haven‚Äôt yet identified a clear pattern among the affected images.  
We‚Äôre not entirely sure where this issue originates, so any hints on what could be causing it or where to start investigating would be very helpful. We‚Äôd also like to contribute to the fix once we understand the root cause.**

- The issue originates from the **sigmoid LUTs (Lookup Tables)** used in some mammography DICOMs.  
- The warning and broken window-level behavior occur when Cornerstone interprets the image as using a **Sigmoid VOI LUT function** (`VOILUTFunction: SIGMOID`), which changes how pixel intensity values are mapped to display brightness.  
- **Linear LUTs** render correctly, but **Sigmoid LUTs** cause the window/level tool to behave unpredictably ‚Äî resulting in extremely large or infinite upper/lower VOI bounds.  
- The problem lies in the **Sigmoid RGB transfer function implementation** in Cornerstone3D. Debugging showed that adjusting the window level triggers numerical instability, with values going out of 32-bit range, causing exceptions.  
- A potential **temporary workaround** is to fall back to a **linear transfer function** until the sigmoid logic is corrected.  
- The fix involves investigating `createSigmoidRGBTransferFunction` in the stack viewport and verifying logic during `vsetvoiGPU`.  
- The correct reference for sigmoid VOI LUTs is in the DICOM Standard, Part 3, Section C.11.2.1.3.1:  
  https://dicom.nema.org/medical/dicom/current/output/html/part03.html#sect_C.11.2.1.3.1  
- Developers traced the issue to changes between **Cornerstone3D v2.11.2 and v2.14.x**, suggesting a regression introduced after refactoring window-level logic to consider VOI LUT functions.  
- A git bisect between those versions can help pinpoint the exact commit that broke sigmoid rendering.  
- The long-term fix will stabilize the sigmoid function‚Äôs math to prevent overflow; for now, reverting to linear behavior when sigmoid is detected is a safe fallback.  

---

‚è±Ô∏è **What is the ETA for this fix and is there any workaround for this issue as it is a blocker for our clients.  
https://github.com/OHIF/Viewers/issues/5057**

- There is **no official ETA** yet for a permanent fix.  
- The **temporary workaround** is to **revert sigmoid LUT handling to linear** by adding a conditional in the code that forces linear window/level behavior when the transfer function is sigmoid.  
- This allows images to render and respond to window/level tools normally while preserving visual accuracy close enough for clinical use.  
- The regression was confirmed to have been introduced between **Cornerstone3D 2.11.2 and 2.14.x**, so developers are isolating the faulty commit through a **git bisect**.  
- Once identified, a PR will follow with the corrected sigmoid logic.  

---
